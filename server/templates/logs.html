{% extends 'base.html' %}
{% block title %}IDS Dashboard{% endblock %}
{% block content %}
<h1 class="mb-4">IDS Monitoring Dashboard</h1>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Suspicious Events by IP</h5>
                <canvas id="ipChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Suspicious Events by Type</h5>
                <canvas id="typeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Raw Logs Row -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Raw Log Stream (Last 50 Events)</h5>
                <div class="btn-group mb-2">
                    <button id="intrusionBtn" class="btn btn-danger active">Intrusion Log</button>
                    <button id="accessBtn" class="btn btn-outline-secondary">Access Log</button>
                </div>
                <pre id="log-output" class="bg-black text-white p-3 rounded" style="height: 400px; overflow-y: scroll;">Loading logs...</pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let ipChartInstance, typeChartInstance;
        const CHART_BG_COLORS = ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)'];

        function createChart(ctx, type, labels, data, label) {
            return new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: CHART_BG_COLORS }] },
                options: { responsive: true, plugins: { legend: { display: type !== 'bar' } } }
            });
        }

        function updateCharts() {
            fetch('/api/log_data')
                .then(response => response.json())
                .then(data => {
                    if (ipChartInstance) ipChartInstance.destroy();
                    const ipCtx = document.getElementById('ipChart').getContext('2d');
                    ipChartInstance = createChart(ipCtx, 'doughnut', data.by_ip.labels, data.by_ip.data, 'Events by IP');

                    if (typeChartInstance) typeChartInstance.destroy();
                    const typeCtx = document.getElementById('typeChart').getContext('2d');
                    typeChartInstance = createChart(typeCtx, 'bar', data.by_type.labels, data.by_type.data, 'Events by Type');
                });
        }
        
        const logOutput = document.getElementById('log-output');
        const intrusionBtn = document.getElementById('intrusionBtn');
        const accessBtn = document.getElementById('accessBtn');

        function fetchRawLogs(type) {
            logOutput.textContent = 'Loading logs...';
            fetch(`/api/raw_logs?type=${type}`)
                .then(response => response.json())
                .then(data => {
                    logOutput.textContent = data.logs || 'No logs found.';
                });
        }

        intrusionBtn.addEventListener('click', () => {
            fetchRawLogs('intrusion');
            intrusionBtn.classList.add('active');
            accessBtn.classList.remove('active');
        });
        accessBtn.addEventListener('click', () => {
            fetchRawLogs('access');
            accessBtn.classList.add('active');
            intrusionBtn.classList.remove('active');
        });

        // Initial Load
        updateCharts();
        fetchRawLogs('intrusion');
        // Refresh data every 10 seconds
        setInterval(updateCharts, 10000);
    });
</script>
{% endblock %}